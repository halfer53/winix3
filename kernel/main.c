/**
 * Main entry point for WINIX.
 *
 * Revision History:
 *  2016-09-19		Paul Monigatti			Original
 **/

#include "winix.h"

/**
 * Print an error message and lock up the OS... the "Blue Screen of Death"
 *
 * Side Effects:
 *   OS locks up.
 **/
void panic(const char* message) {
	printf("\r\nPanic! ");
	printf(message);

	while(1) {
		RexParallel->Ctrl = 0;
		RexParallel->LeftSSD = 0x79;  //E
		RexParallel->RightSSD = 0x50; //r
	}
}

/**
 * Asserts that a condition is true.
 * If so, this function has no effect.
 * If not, panic is called with the appropriate message.
 */
void assert(int expression, const char *message) {
	if(!expression) {
		printf("\r\nAssertion Failed");
		panic(message);
	}
}

/**
 * Entry point for WINIX.
 **/
void main() {
	size_t init_code[2] = {0x01010000,
											0x50f00000};
	size_t shell_code_length = 967;
	//size_t shell_code[967] = {0x000003c0,0x0000003f,0x000003b7,0x0000006a,0x000003b2,0x00000075,0x000003af,0x00000035,0x000003aa,0x00000029,0x000003a5,0x00000027,0x0000039d,0x00000025,0x00000000,0x00000083,0x1ee30004,0x97e00000,0x9ce00001,0x9de00002,0x8de00004,0x9de00003,0x1c010021,0x2dc2000d,0xb0d00005,0x8de00003,0x3dd2007e,0xb0d00002,0x17010001,0x4000001f,0x07010000,0x01010007,0x87e00000,0x8ce00001,0x8de00002,0x1ee10004,0x50f00000,0x01010000,0x50f00000,0x01010000,0x50f00000,0x1ee30003,0x9de00000,0x9fe00001,0x90e00002,0x600002ac,0x0d010001,0x9de00002,0x01010000,0x8de00000,0x8fe00001,0x1ee10003,0x50f00000,0x1ee30002,0x9de00000,0x9fe00001,0x6000029b,0x0d010001,0x0101000d,0x8de00000,0x8fe00001,0x1ee10002,0x50f00000,0x1ee3000f,0x94e00006,0x95e00007,0x96e00008,0x97e00009,0x9be0000a,0x9ce0000b,0x9de0000c,0x9fe0000d,0x60000277,0x0d010001,0x0701000d,0x1d01003c,0x0476000d,0x0546000d,0x0656000d,0x1c010018,0x0b66000c,0x9be0000e,0x0448000d,0x0558000d,0x0668000c,0x17780064,0xcd00037e,0x9de00000,0x8de0000e,0x9de00001,0x96e00002,0x95e00003,0x94e00004,0x97e00005,0x6000018d,0x01010000,0x84e00006,0x85e00007,0x86e00008,0x87e00009,0x8be0000a,0x8ce0000b,0x8de0000c,0x8fe0000d,0x1ee1000f,0x50f00000,0x1ee30003,0x9de00001,0x9fe00002,0xcd000363,0x9de00000,0x6000018d,0x01010000,0x8de00001,0x8fe00002,0x1ee10003,0x50f00000,0x1ee30003,0x9de00001,0x9fe00002,0xcd00035c,0x9de00000,0x6000018d,0x90e00000,0x60000288,0x0d010001,0x0101000d,0x8de00001,0x8fe00002,0x1ee10003,0x50f00000,0x1ee30004,0x9de00002,0x9fe00003,0x8de00004,0x2dda0000,0xb0d00002,0x01010000,0x40000093,0xcd000345,0x9de00000,0x8de00005,0x8dd00000,0x9de00001,0x6000018d,0x310effff,0x111dffff,0x8de00002,0x8fe00003,0x1ee10004,0x50f00000,0x1ee3000b,0x94e00002,0x95e00003,0x96e00004,0x97e00005,0x9ce00006,0x9de00007,0x9fe00008,0x05010000,0x40000101,0xcd00033d,0x9de00000,0x6000018d,0x06010000,0x6000011f,0x0d010001,0x9d6003f9,0x8d6003f9,0x3dda000d,0xb0d00001,0x400000bd,0x8d6003f9,0x3dda0008,0xb0d00008,0x2d680000,0xb0d00004,0x8d6003f9,0x9de00000,0x6000010b,0x16620001,0x16620001,0x400000ba,0x8d6003f9,0x9de00000,0x6000010b,0x16600001,0x3d600063,0xb0dfffe8,0x1d600001,0x0601000d,0x90d003f9,0xcd00033a,0x9de00000,0x6000018d,0x04010000,0xc70003f9,0x400000e9,0x17710001,0x8d700000,0x9de0000a,0x2dd80000,0xb0d00006,0x8de0000a,0x9de00000,0x60000010,0x0d010001,0x2dd80000,0xb0dffff5,0x8d700000,0x2dd80000,0xb0d00005,0x0d010004,0x14d00001,0x97d003c7,0x400000d9,0x17710001,0x8d700000,0x9de00009,0x2dd80000,0xb0d00006,0x8de00009,0x9de00000,0x60000010,0x0d010001,0x2dda0000,0xb0dffff5,0x8d700000,0x2dd80000,0xb0d00003,0x0d010007,0x17d10001,0x90d00000,0x8d700000,0x2dda0000,0xb0dfffdb,0xc5000000,0x400000ef,0x15510002,0x8d500000,0x9de0000a,0x0c01000d,0x2dc90000,0xb0d00008,0x8d0003c7,0x9de00000,0x8de0000a,0x9de00001,0x600001dd,0x0d010001,0x2dda0000,0xb0dffff2,0x94e00000,0xcd0003c7,0x9de00001,0x8d500001,0x70d00000,0x400000a1,0x84e00002,0x85e00003,0x86e00004,0x87e00005,0x8ce00006,0x8de00007,0x8fe00008,0x1ee1000b,0x50f00000,0x1ee30002,0x9ce00000,0x9de00001,0x8de00002,0x9de00002,0x3d0e0007,0x1ddd0003,0x8dd00000,0x1ddb0002,0x2dd80000,0xb0dffffa,0x3d0e0007,0x1ddd0000,0x8ce00002,0x9cd00000,0x01010000,0x8ce00000,0x8de00001,0x1ee10002,0x50f00000,0x1ee30001,0x9de00000,0x3d0e0007,0x1ddd0003,0x8dd00000,0x1ddb0001,0x2dd80000,0xb0dffffa,0x3d0e0007,0x1ddd0001,0x81d00000,0x8de00000,0x1ee10001,0x50f00000,0x1ee30006,0x96e00001,0x97e00002,0x9ce00003,0x9de00004,0x9fe00005,0x370e3b9a,0x177dca00,0x8de00006,0x2dda0000,0xb0d00004,0x1d010030,0x9de00000,0x6000010b,0x40000156,0x8de00006,0x2dd60000,0xb0d0000a,0x1d01002d,0x9de00000,0x6000010b,0x3d0effff,0x1dddffff,0x8ce00006,0x0dd4000c,0x9de00006,0x40000149,0x1776000a,0x8de00006,0x2d72000d,0xb0dffffc,0x40000154,0x8de00006,0x06d60007,0x1d68000a,0x1dd00030,0x9de00000,0x6000010b,0x1776000a,0x2d7a0000,0xb0dffff7,0x86e00001,0x87e00002,0x8ce00003,0x8de00004,0x8fe00005,0x1ee10006,0x50f00000,0x1ee30005,0x96e00001,0x97e00002,0x9de00003,0x9fe00004,0x1701001c,0x8de00005,0x0dde0007,0x16db000f,0x3d66000a,0xb0d00004,0x1d600030,0x9de00000,0x6000010b,0x40000170,0x1d62000a,0x1dd00041,0x9de00000,0x6000010b,0x17720004,0x2d760000,0xb0dffff0,0x86e00001,0x87e00002,0x8de00003,0x8fe00004,0x1ee10005,0x50f00000,0x1ee30004,0x9ce00001,0x9de00002,0x9fe00003,0x40000184,0x8de00004,0x1cd10001,0x9ce00004,0x8dd00000,0x9de00000,0x6000010b,0x8de00004,0x8dd00000,0x2dda0000,0xb0dffff6,0x8ce00001,0x8de00002,0x8fe00003,0x1ee10004,0x50f00000,0x1ee30007,0x96e00001,0x97e00002,0x9ce00003,0x9de00004,0x9fe00005,0x17e10007,0x17710001,0x400001d1,0x8de00007,0x8dd00000,0x3dda0025,0xb0d00031,0x8de00007,0x1dd10001,0x9de00007,0x8de00007,0x86d00000,0x1d010073,0x9de00006,0x2d68000d,0xb0d00019,0x8de00006,0x2d62000d,0xb0d00003,0x3d680064,0xb0d00004,0x400001c4,0x3d680078,0xb0d00009,0x400001c4,0x8d700000,0x9de00000,0x6000012d,0x17710001,0x8de00007,0x1dd10001,0x9de00007,0x400001d1,0x8d700000,0x9de00000,0x6000015d,0x17710001,0x8de00007,0x1dd10001,0x9de00007,0x400001d1,0x8d700000,0x9de00000,0x60000179,0x17710001,0x8de00007,0x1dd10001,0x9de00007,0x400001d1,0x8de00007,0x1cd10001,0x9ce00007,0x8dd00000,0x9de00000,0x6000010b,0x400001d1,0x8de00007,0x1cd10001,0x9ce00007,0x8dd00000,0x9de00000,0x6000010b,0x8de00007,0x8dd00000,0x2dda0000,0xb0dfffc1,0x01010000,0x86e00001,0x87e00002,0x8ce00003,0x8de00004,0x8fe00005,0x1ee10007,0x50f00000,0x1ee30003,0x9ce00000,0x9de00001,0x400001ee,0x8de00003,0x8dd00000,0x8ce00004,0x8cc00000,0x2dd8000c,0xb0d00001,0x400001f9,0x8de00003,0x1dd10001,0x9de00003,0x8de00004,0x1dd10001,0x9de00004,0x0d010000,0x9de00002,0x8ce00003,0x8cc00000,0x2dc8000d,0xb0d00005,0x8de00004,0x8dd00000,0x8ce00002,0x2dda000c,0xb0dfffe8,0x8de00003,0x8dd00000,0x8ce00004,0x8cc00000,0x01d2000c,0x8ce00000,0x8de00001,0x1ee10003,0x50f00000,0x1ee30003,0x97e00000,0x9ce00001,0x9de00002,0x07010000,0x40000209,0x17700001,0x8de00003,0x1cd10001,0x9ce00003,0x8dd00000,0x2dda0000,0xb0dffff9,0x01010007,0x87e00000,0x8ce00001,0x8de00002,0x1ee10003,0x50f00000,0x1ee30004,0x9be00000,0x9ce00001,0x9de00002,0x8de00004,0x9de00003,0x40000224,0x8de00004,0x1cd10001,0x9ce00004,0x8ce00005,0x1bc10001,0x9be00005,0x8cc00000,0x9cd00000,0x8de00005,0x8dd00000,0x2dda0000,0xb0dffff4,0x8de00004,0x90d00000,0x81e00003,0x8be00000,0x8ce00001,0x8de00002,0x1ee10004,0x50f00000,0x1ee30004,0x96e00000,0x97e00001,0x9ce00002,0x9de00003,0x06010000,0x07010000,0x40000239,0x16600001,0x8de00004,0x0d61000d,0x8dd00000,0x2dda0000,0xb0dffffa,0x40000247,0x0d600007,0x8ce00004,0x0dd1000c,0x8ce00005,0x0c71000c,0x8cc00000,0x9cd00000,0x17700001,0x8de00005,0x0d71000d,0x8dd00000,0x2dda0000,0xb0dffff3,0x0d600007,0x8ce00004,0x0dd1000c,0x90d00000,0x81e00004,0x86e00000,0x87e00001,0x8ce00002,0x8de00003,0x1ee10004,0x50f00000,0x1ee30004,0x96e00000,0x97e00001,0x9ce00002,0x9de00003,0x07010000,0x06010000,0x87e00006,0x40000268,0x8de00004,0x0d61000d,0x8ce00005,0x0c71000c,0x8cc00000,0x9cd00000,0x16600001,0x17700001,0x8de00007,0x8ce00006,0x0dd0000c,0x2d70000d,0xb0dffff3,0x8de00004,0x0d61000d,0x90d00000,0x01010006,0x86e00000,0x87e00001,0x8ce00002,0x8de00003,0x1ee10004,0x50f00000,0x1ee3000e,0x9de00002,0x9fe00003,0x90e00004,0x1d010004,0x9de00006,0x90e00000,0x1de10005,0x9de00001,0x60000327,0x0d010001,0x9de00004,0x81e00007,0x8de00002,0x8fe00003,0x1ee1000e,0x50f00000,0x1ee3000e,0x9de00002,0x9fe00003,0x90e00004,0x1d010005,0x9de00006,0x8de0000e,0x9de00007,0x90e00000,0x1de10005,0x9de00001,0x60000327,0x0d010001,0x9de00004,0x81e00007,0x8de00002,0x8fe00003,0x1ee1000e,0x50f00000,0x1ee3000e,0x9de00002,0x9fe00003,0x90e0000d,0x1d010006,0x9de00005,0x90e00000,0x1de10004,0x9de00001,0x60000306,0x0d010001,0x9de0000d,0x01010000,0x8de00002,0x8fe00003,0x1ee1000e,0x50f00000,0x1ee3000e,0x9de00002,0x9fe00003,0x90e0000d,0x1d010007,0x9de00005,0x90e00000,0x1de10004,0x9de00001,0x60000306,0x0d010001,0x9de0000d,0x01010000,0x8de00002,0x8fe00003,0x1ee1000e,0x50f00000,0x1ee3000e,0x9de00002,0x9fe00003,0x90e0000d,0x1d010007,0x9de00005,0x90e00000,0x1de10004,0x9de00001,0x60000306,0x0d010001,0x9de0000d,0x01010000,0x8de00002,0x8fe00003,0x1ee1000e,0x50f00000,0x1ee3000e,0x9de00002,0x9fe00003,0x90e00004,0x1d010007,0x9de00006,0x8de0000e,0x9de0000d,0x90e00000,0x1de10005,0x9de00001,0x60000327,0x0d010001,0x9de00004,0x81e0000a,0x8de00002,0x8fe00003,0x1ee1000e,0x50f00000,0x1ee3000e,0x9de00002,0x9fe00003,0x90e00004,0x1d01000b,0x9de00006,0x8de0000e,0x9de0000d,0x90e00000,0x1de10005,0x9de00001,0x60000327,0x0d010001,0x9de00004,0x81e0000a,0x8de00002,0x8fe00003,0x1ee1000e,0x50f00000,0x1ee3000e,0x9de00002,0x9fe00003,0x90e00004,0x1d01000c,0x9de00006,0x8de0000e,0x9de0000a,0x90e00000,0x1de10005,0x9de00001,0x60000306,0x0d010001,0x9de00004,0x8de00002,0x8fe00003,0x1ee1000e,0x50f00000,0x1ee30005,0x9de00003,0x9fe00004,0x3d0e1337,0x1ddd0001,0x9de00000,0x8de00005,0x9de00001,0x8de00006,0x9de00002,0x60000338,0x0d010001,0x0101000d,0x8de00003,0x8fe00004,0x1ee10005,0x50f00000,0x1ee30005,0x9de00003,0x9fe00004,0x3d0e1337,0x1ddd0002,0x9de00000,0x90e00001,0x8de00005,0x9de00002,0x60000338,0x0d010001,0x0101000d,0x8de00003,0x8fe00004,0x1ee10005,0x50f00000,0x1ee30005,0x9de00003,0x9fe00004,0x3d0e1337,0x1ddd0003,0x9de00000,0x8de00005,0x9de00001,0x8de00006,0x9de00002,0x60000338,0x0d010001,0x0101000d,0x8de00003,0x8fe00004,0x1ee10005,0x50f00000,0x200d0000,0x50f00000,0x0000000d,0x0000000a,0x00000000,0x00000057,0x00000049,0x0000004e,0x00000049,0x00000058,0x0000003e,0x00000020,0x00000000,0x00000055,0x0000006e,0x0000006b,0x0000006e,0x0000006f,0x00000077,0x0000006e,0x00000020,0x00000063,0x0000006f,0x0000006d,0x0000006d,0x00000061,0x0000006e,0x00000064,0x00000020,0x00000027,0x00000025,0x00000073,0x00000027,0x0000000d,0x0000000a,0x00000000,0x00000042,0x00000079,0x00000065,0x00000021,0x0000000d,0x0000000a,0x00000000,0x00000050,0x0000006c,0x00000061,0x00000063,0x00000065,0x00000068,0x0000006f,0x0000006c,0x00000064,0x00000065,0x00000072,0x00000020,0x00000066,0x0000006f,0x00000072,0x00000020,0x00000053,0x00000048,0x00000055,0x00000054,0x00000044,0x0000004f,0x00000057,0x0000004e,0x0000000d,0x0000000a,0x00000000,0x00000055,0x00000070,0x00000074,0x00000069,0x0000006d,0x00000065,0x00000020,0x00000069,0x00000073,0x00000020,0x00000025,0x00000064,0x00000064,0x00000020,0x00000025,0x00000064,0x00000068,0x00000020,0x00000025,0x00000064,0x0000006d,0x00000020,0x00000025,0x00000064,0x0000002e,0x00000025,0x00000064,0x00000073,0x0000000d,0x0000000a,0x00000000,0x00000074,0x00000065,0x00000073,0x00000074,0x0000006d,0x00000061,0x0000006c,0x00000000,0x00000065,0x00000078,0x00000065,0x00000063,0x00000000,0x00000066,0x0000006f,0x00000072,0x0000006b,0x00000000,0x00000070,0x00000073,0x00000000,0x00000065,0x00000078,0x00000069,0x00000074,0x00000000,0x00000073,0x00000068,0x00000075,0x00000074,0x00000064,0x0000006f,0x00000077,0x0000006e,0x00000000,0x00000075,0x00000070,0x00000074,0x00000069,0x0000006d,0x00000065,0x00000000};

	size_t shell_pc = 0x00000097;
	size_t init_pc = 0x00000000;

	proc_t *p = NULL;
	size_t *ptr = NULL;
	void *addr_p = NULL;
	int pid = 0;
	int i=0;

	//Print boot message.
	printf("\r\nWINIX v%d.%d\r\n", MAJOR_VERSION, MINOR_VERSION);

	//scan memory, initialise FREE_MEM_BEGIN and FREE_MEM_END
	Scan_FREE_MEM_BEGIN();
	init_memory();

	//Set up process table
	init_proc();

	//Initialise the system task
	p = new_proc(system_main, SYSTEM_PRIORITY, "SYSTEM");
	assert(p != NULL, "Create sys task");
	p->quantum = 64;

	//Idle Task
	p = new_proc(idle_main, IDLE_PRIORITY, "IDLE");
	assert(p != NULL, "Create idle task");


	//init.c
	//p =  new_proc_from_binaryRecords(init_code, 2, init_pc,USER_PRIORITY,"init");
	// addr_p = (void *)load_BinRecord_Mem(init_code,2);
	// //printf("addr_p 0x%x\n",addr_p );
	// p = (proc_t *)new_proc((void (*)())init_pc,USER_PRIORITY, "init");
	// p->rbase = addr_p;
	// p->sp = (void *)((size_t *)(p->sp) - (size_t *)addr_p);
	// p->length = 2;
	// assert(p != NULL, "Create init task");
	// p->quantum = 1;


	//###########################################
	//Shell
	// pid = fork_proc(p);
	// printf("fork b id %d, rbase %x, sp %x\n",p->proc_index,(size_t *)p->rbase,p->sp );
	// p = get_proc(pid);
	// printf("fork a id %d, rbase %x, sp %x\n",p->proc_index,(size_t *)p->rbase,p->sp );
	//
	// assert(p != NULL, "Create shell task");
	// printProceInfo(p);
	//
	// _free(p->rbase);
	// proc_set_default(p);




	// p = new_proc_from_binaryRecords(shell_code, shell_code_length, shell_pc,USER_PRIORITY,"shell");
	// printProceInfo(p);
	// addr_p = (void *)exec_binary(p, shell_code, shell_code_length);
	// printf("received addr_p %x\n",(size_t *)addr_p );
	//
	// p->priority = USER_PRIORITY;
	// p->pc = (void (*)())shell_pc;
	//
	// p->ptable = p->protection_table;
	// for(i = 0; i < PROTECTION_TABLE_LEN; i++) {
	// 	p->protection_table[i] = 0xffffffff;
	// }
	//
	// //reset the stack
	// p->sp = p->malloced_sp + (size_t)DEFAULT_STACK_SIZE;
	//
	// p->length = shell_code_length;
	//
	// strcpy(p->name,"shell");
	//
	// //p = (proc_t *)new_proc((void *)shell_pc, USER_PRIORITY, "shell");
	// p->rbase = addr_p;
	// p->sp = (void *)((size_t *)(p->sp) - (size_t *)addr_p);
	// p->length = 968;
	//

	p = new_proc(shell_main, USER_PRIORITY, "Shell");
	assert(p!=NULL,"create shell ");
	p->quantum = 2;

	//pid = fork_proc(p);

	// p = exec_proc(shell_code,shell_code_length,shell_pc, USER_PRIORITY,"Shell2");
	// p->quantum = 10;

	process_overview();


	//Rocks game
	/*p = new_proc(rocks_main, USER_PRIORITY, "Rocks");
	assert(p != NULL, "Create rocks task");
	p->quantum = 4;*/

	//Parallel test program
	// p = new_proc(parallel_main, USER_PRIORITY, "Parallel");
	// assert(p != NULL, "Create parallel task");
	// p->quantum = 1;
	//###########################################





	//printf("suc\n" );
	//Initialise exceptions
	init_exceptions();

	//Kick off first task. Note: never returns.
	sched();
}
